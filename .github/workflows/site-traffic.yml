name: Site Traffic & Keep Alive

on:
  schedule:
    # Run every 10 minutes to keep Render alive
    - cron: '*/10 * * * *'
  workflow_dispatch: # Allow manual trigger

jobs:
  keep-alive:
    runs-on: ubuntu-latest
    
    steps:
      - name: Keep Backend Alive
        run: |
          echo "ÔøΩ Keeping  BillByteKOT backend alive..."
          
          # Wake up Render backend (free tier sleeps after 15 min inactivity)
          for i in {1..5}; do
            response=$(curl -s -o /dev/null -w "%{http_code}" "https://restro-ai.onrender.com/health" --max-time 60 || echo "000")
            if [ "$response" = "200" ]; then
              echo "‚úÖ Backend is alive! (attempt $i)"
              break
            else
              echo "‚è≥ Waking up backend... (attempt $i, status: $response)"
              sleep 10
            fi
          done
          
          # Additional health checks
          curl -s -o /dev/null "https://restro-ai.onrender.com/" --max-time 30 || true
          echo "‚úÖ Backend keep-alive complete!"

      - name: Visit Frontend Pages
        run: |
          echo "üåê Visiting BillByteKOT frontend..."
          
          # Visit main page (SPA - all routes serve index.html)
          response=$(curl -s -o /dev/null -w "%{http_code}" "https://billbytekot.in" --max-time 30 || echo "000")
          echo "Homepage: $response"
          
          # Visit with different user agents to simulate real traffic
          USER_AGENTS=(
            "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 Chrome/120.0.0.0 Safari/537.36"
            "Mozilla/5.0 (iPhone; CPU iPhone OS 17_0 like Mac OS X) AppleWebKit/605.1.15 Safari/604.1"
            "Mozilla/5.0 (Linux; Android 14) AppleWebKit/537.36 Chrome/120.0.0.0 Mobile Safari/537.36"
            "Googlebot/2.1 (+http://www.google.com/bot.html)"
          )
          
          for ua in "${USER_AGENTS[@]}"; do
            curl -s -o /dev/null -A "$ua" "https://billbytekot.in" --max-time 15 || true
            sleep 2
          done
          
          echo "‚úÖ Frontend visits complete!"

      - name: Ping Search Engines
        run: |
          echo "üîç Pinging search engines..."
          
          # Ping Google with sitemap
          curl -s "https://www.google.com/ping?sitemap=https://billbytekot.in/sitemap.xml" --max-time 10 > /dev/null 2>&1 && echo "‚úÖ Google pinged" || echo "‚ö†Ô∏è Google ping failed"
          
          # Ping Bing with sitemap
          curl -s "https://www.bing.com/ping?sitemap=https://billbytekot.in/sitemap.xml" --max-time 10 > /dev/null 2>&1 && echo "‚úÖ Bing pinged" || echo "‚ö†Ô∏è Bing ping failed"
          
          echo "‚ú® Search engine pings complete!"

      - name: Check AssetLinks
        run: |
          echo "üì± Checking Android AssetLinks..."
          response=$(curl -s "https://billbytekot.in/.well-known/assetlinks.json" --max-time 15 || echo "error")
          if echo "$response" | grep -q "3A:B4:A6:42"; then
            echo "‚úÖ AssetLinks configured correctly!"
          else
            echo "‚ö†Ô∏è AssetLinks may need attention"
            echo "$response" | head -c 200
          fi
