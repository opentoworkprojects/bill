<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Print Settings Save</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .success { background-color: #d4edda; border-color: #c3e6cb; }
        .error { background-color: #f8d7da; border-color: #f5c6cb; }
        .info { background-color: #d1ecf1; border-color: #bee5eb; }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background: #0056b3; }
        button:disabled { background: #6c757d; cursor: not-allowed; }
        pre { background: #f8f9fa; padding: 10px; border-radius: 3px; overflow-x: auto; }
        .log { max-height: 300px; overflow-y: auto; }
    </style>
</head>
<body>
    <h1>ðŸ§ª Print Settings Save Test</h1>
    
    <div class="test-section info">
        <h3>Test Status</h3>
        <p id="status">Ready to test</p>
        <button onclick="runTest()" id="testBtn">Run Test</button>
        <button onclick="clearLog()" id="clearBtn">Clear Log</button>
    </div>

    <div class="test-section">
        <h3>Test Log</h3>
        <div id="log" class="log"></div>
    </div>

    <script>
        const API_BASE = 'http://localhost:8000/api';
        let testToken = null;

        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            const className = type === 'error' ? 'error' : type === 'success' ? 'success' : 'info';
            logDiv.innerHTML += `<div class="${className}">[${timestamp}] ${message}</div>`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function clearLog() {
            document.getElementById('log').innerHTML = '';
        }

        function updateStatus(message, type = 'info') {
            const statusEl = document.getElementById('status');
            statusEl.textContent = message;
            statusEl.className = type;
        }

        async function login() {
            log('ðŸ” Attempting login...');
            try {
                const response = await fetch(`${API_BASE}/auth/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        username: 'shivshankarkumar281@gmail.com',
                        password: 'shiv@123'
                    })
                });

                if (!response.ok) {
                    throw new Error(`Login failed: ${response.status} ${response.statusText}`);
                }

                const data = await response.json();
                testToken = data.token;
                
                if (!testToken) {
                    throw new Error('No token received from login');
                }

                log('âœ… Login successful', 'success');
                log(`Token: ${testToken.substring(0, 20)}...`);
                return true;
            } catch (error) {
                log(`âŒ Login failed: ${error.message}`, 'error');
                return false;
            }
        }

        async function getCurrentSettings() {
            log('ðŸ“‹ Getting current business settings...');
            try {
                const response = await fetch(`${API_BASE}/business/settings`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${testToken}`,
                        'Content-Type': 'application/json',
                    }
                });

                if (!response.ok) {
                    throw new Error(`Get settings failed: ${response.status} ${response.statusText}`);
                }

                const data = await response.json();
                log('âœ… Current settings retrieved', 'success');
                log(`Current print_customization: ${data.business_settings?.print_customization ? 'exists' : 'null'}`);
                return data.business_settings || {};
            } catch (error) {
                log(`âŒ Get settings failed: ${error.message}`, 'error');
                return null;
            }
        }

        async function saveSettings(settings) {
            log('ðŸ’¾ Saving print settings...');
            try {
                // Simulate the exact same request that the frontend makes
                const requestBody = {
                    ...settings,
                    print_customization: {
                        paper_width: "80mm",
                        font_size: "medium",
                        header_style: "centered",
                        show_logo: true,
                        logo_size: "medium",
                        show_address: true,
                        show_phone: true,
                        show_email: false,
                        show_website: false,
                        show_gstin: true,
                        show_fssai: false,
                        show_tagline: true,
                        show_customer_name: true,
                        show_waiter_name: true,
                        show_table_number: true,
                        show_order_time: true,
                        show_item_notes: true,
                        border_style: "single",
                        separator_style: "dashes",
                        footer_style: "simple",
                        qr_code_enabled: true,
                        auto_print: false,
                        print_copies: 3, // Test value to verify save
                        kot_auto_print: true,
                        kot_font_size: "large",
                        kot_show_time: true,
                        kot_highlight_notes: true
                    }
                };

                log(`Request body: ${JSON.stringify(requestBody, null, 2)}`);

                const response = await fetch(`${API_BASE}/business/settings`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${testToken}`,
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(requestBody)
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`Save failed: ${response.status} ${response.statusText} - ${errorText}`);
                }

                const data = await response.json();
                log('âœ… Settings saved successfully', 'success');
                log(`Response: ${data.message}`);
                return true;
            } catch (error) {
                log(`âŒ Save failed: ${error.message}`, 'error');
                return false;
            }
        }

        async function verifySettings() {
            log('ðŸ” Verifying saved settings...');
            try {
                const response = await fetch(`${API_BASE}/business/settings`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${testToken}`,
                        'Content-Type': 'application/json',
                    }
                });

                if (!response.ok) {
                    throw new Error(`Verify failed: ${response.status} ${response.statusText}`);
                }

                const data = await response.json();
                const printSettings = data.business_settings?.print_customization;
                
                if (!printSettings) {
                    throw new Error('Print customization settings not found');
                }

                const savedPrintCopies = printSettings.print_copies;
                const expectedPrintCopies = 3;

                if (savedPrintCopies === expectedPrintCopies) {
                    log('âœ… Settings verified successfully', 'success');
                    log(`Saved print_copies: ${savedPrintCopies} (expected: ${expectedPrintCopies})`);
                    return true;
                } else {
                    log(`âŒ Settings verification failed`, 'error');
                    log(`Saved print_copies: ${savedPrintCopies} (expected: ${expectedPrintCopies})`);
                    return false;
                }
            } catch (error) {
                log(`âŒ Verify failed: ${error.message}`, 'error');
                return false;
            }
        }

        async function runTest() {
            const testBtn = document.getElementById('testBtn');
            testBtn.disabled = true;
            testBtn.textContent = 'Testing...';
            
            updateStatus('Running test...', 'info');
            clearLog();

            try {
                // Step 1: Login
                const loginSuccess = await login();
                if (!loginSuccess) {
                    updateStatus('Test failed: Login error', 'error');
                    return;
                }

                // Step 2: Get current settings
                const currentSettings = await getCurrentSettings();
                if (!currentSettings) {
                    updateStatus('Test failed: Could not get current settings', 'error');
                    return;
                }

                // Step 3: Save settings
                const saveSuccess = await saveSettings(currentSettings);
                if (!saveSuccess) {
                    updateStatus('Test failed: Save error', 'error');
                    return;
                }

                // Step 4: Verify settings
                const verifySuccess = await verifySettings();
                if (!verifySuccess) {
                    updateStatus('Test failed: Verification error', 'error');
                    return;
                }

                updateStatus('ðŸŽ‰ Test completed successfully!', 'success');
                log('ðŸŽ‰ All tests passed! Print settings save functionality is working correctly.', 'success');

            } catch (error) {
                log(`âŒ Unexpected error: ${error.message}`, 'error');
                updateStatus('Test failed: Unexpected error', 'error');
            } finally {
                testBtn.disabled = false;
                testBtn.textContent = 'Run Test';
            }
        }

        // Test localStorage functionality
        function testLocalStorage() {
            log('ðŸ§ª Testing localStorage functionality...');
            try {
                // Test setting and getting from localStorage
                const testData = { test: 'value', timestamp: Date.now() };
                localStorage.setItem('test_print_settings', JSON.stringify(testData));
                
                const retrieved = JSON.parse(localStorage.getItem('test_print_settings'));
                if (retrieved && retrieved.test === 'value') {
                    log('âœ… localStorage is working correctly', 'success');
                } else {
                    log('âŒ localStorage test failed', 'error');
                }
                
                // Clean up
                localStorage.removeItem('test_print_settings');
            } catch (error) {
                log(`âŒ localStorage error: ${error.message}`, 'error');
            }
        }

        // Run localStorage test on page load
        window.addEventListener('load', () => {
            testLocalStorage();
        });
    </script>
</body>
</html>